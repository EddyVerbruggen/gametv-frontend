<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=0"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <title>Game TV</title>
  <!-- NOTE: jqm loads the HEAD only once per session, so we need to include all css and js on every page (not only the first, because a reload of a page need to load all css/js as well) -->
  <link rel="stylesheet" href="js/lib/jquery.mobile-1.2.0/jquery.mobile-1.2.0.min.css"/>
  <link rel="stylesheet" href="js/lib/jquery.mobile-1.2.0/jquery.mobile.theme-1.2.0.min.css"/>
  <link rel="stylesheet" href="css/gametv.custom.css"/>
  <link rel="apple-touch-icon" href="icon.png"/><!-- for webapp usage (not intended btw, but is possible) -->
  <script src="js/lib/jquery.js"></script>
  <script src="js/gametv.custom.js"></script>
  <script src="js/jqm-init.js"></script>
  <script src="js/lib/jquery.mobile-1.2.0/jquery.mobile-1.2.0.min.js"></script>
  <script src="phonegap.js"></script>
  <script type="text/javascript">
    $(document).ready(function () {
      // if this is the first time (not returning from a video), load the list from the server
      if (sessionStorage.getItem("videosources") == null) {
        loadVideos();
      }
      // in case we're returning from a videoplayer, we need to go to the correct details page (otherwise the videosources are shown)
//      var videosourceid = getUrlParam("videosourceid");
//      if (videosourceid != null) {
//        $.mobile.changePage("#videos?videosourceid="+videosourceid);
//      }

      $('#videos').on('pagebeforeshow', function (e, data) {
        var videosourceid = getUrlParam("videosourceid");
        renderVideoList(videosourceid);
      });

      $('#videoplayer').on('pagebeforeshow', function (e, data) {
        var videosourceid = getUrlParam("videosourceid");
        var videoid = getUrlParam("videoid");
        renderVideoPlayer(videosourceid, videoid);
      });

      $("#popupPanel").on("popupbeforeposition", function() {
        $("#popupPanel").css("height", $(window).height());
      });

      $("#downloadApp").attr("href", isAndroid() ? "https://build.phonegap.com/apps/267637/download/android/?qr_key=sfqjvxAqyAAjSQvtB7pu" : "https://build.phonegap.com/apps/267637/download/ios/?qr_key=sfqjvxAqyAAjSQvtB7pu");
    });

    function loadVideos() {
      var cachedVideos = localStorage.getItem("videosources");
      if (cachedVideos != null) {
        renderVideoSourceList(JSON.parse(cachedVideos));
      }
      $.getJSON(getServiceURL("/videosource/all"))
          .success(function (data) {
            localStorage.setItem("videosources", JSON.stringify(data));
            renderVideoSourceList(data);
          })
          .error(function () {
            if (cachedVideos == null) {
              $(".feedback").html("Well, there was an error loading the videos from the server. Please try again later..");
            } else {
              $(".feedback").html("Failed to fetch latest videos, showing the last known list.");
            }
          })
    }

    function renderVideoSourceList(videosources) {
      var htmlVideosource = '';
      var htmlVideo = '';
      $.each(videosources, function (i, videosource) {

        // TODO: iCanHaz?
        if (videosource.videoList.length > 0) { // no empty channels
          htmlVideosource += '' +
              '<li>' +
              '  <a href="#videos?videosourceid=' + videosource.id + '" data-transition="slide">' +
              '    <img src="img/videosources/' + videosource.image + '" />' +
              '    <h3>' + videosource.name + '</h3>' +
              '    <p>' + videosource.website + '</p>' +
              '    <span class="ui-li-count">' + videosource.videoList.length + '</span>' + // TODO (later): show new-count
              '  </a>' +
              '</li>';
        }
      });
      $("#videosourceList").html(htmlVideosource);
      $("#videosourceList").listview('refresh');

      $("#videoList").html(htmlVideo);
//      $("#videoList").listview('refresh');
    }

    function renderVideoList(videosourceid) {
      var cachedVideos = localStorage.getItem("videosources");
      var videosources = JSON.parse(cachedVideos);

      // find the correct videosource in the cache
      $.each(videosources, function (i, videosource) {
        if (videosource.id == videosourceid) {
          // set the header
          $("#videos h1").html(videosource.name);
          // render the videolist
          var htmlVideo = '';
          $.each(videosource.videoList, function (j, video) {
            var date = new Date(video.date);
            // TODO: iCanHaz?
            htmlVideo += '' +
                '<li>' +
                '  <a href="#videoplayer?videosourceid='+videosource.id+'&videoid='+video.id+'">' +
                '    <img src="' + video.imageurl + '" alt="' + video.title + '"/>' +
                '    <h3>' + video.title + '</h3>' +
                '    <p>' + date.getDate() + "-" + (date.getMonth() + 1) + "-" + date.getFullYear() + '</p>' +
                '  </a>' +
                '</li>';
          });

          $("#videoList").html(htmlVideo);
          $("#videoList").listview('refresh');

          //  break the loop
          return false;
        }
      })
    }

    function renderVideoPlayer(videosourceid, videoid) {
      var cachedVideos = localStorage.getItem("videosources");
      var videosources = JSON.parse(cachedVideos);

      // find the correct videosource in the cache
      $.each(videosources, function (i, videosource) {
        if (videosource.id == videosourceid) {
         // find the correct video in the cache
          $.each(videosource.videoList, function (i, video) {
            if (video.id == videoid) {

              // set the header
              $("#videoplayer h1").html(video.title);

              // render the player
              $("#videoplayer video").attr("poster", video.imageurl);
              $("#videoplayer video").attr("src", video.videourl);
              $("#videoplayer video object param:first-child").attr("value", video.videourl);
              $("#videoplayer video object embed").attr("src", video.videourl);
              $("#videoplayer #mailbody").html('Check de video "'+video.title+'": ' + video.pageurl);
              $("#videoplayer #description").html(video.description + (video.description.length == 255 ? ".." : "")); // TODO serverfix & remove any links and images!

              return false; // breaks the loop
            }
          })
        }
      })
    }
  </script>
</head>
<body>


<!-- PAGE 1 -->
<div data-role="page" id="videosources">

  <div data-role="header" data-position="fixed">
    <a id="downloadApp" data-icon="refresh" href="#">update app</a>

    <h1>Game TV kanalen</h1>
    <a data-icon="grid" data-iconpos="right" href="#popupPanel" data-rel="popup" data-transition="slide" data-position-to="window">menu</a>
  </div>

  <div data-role="popup" id="popupPanel" data-corners="false" data-theme="none" data-shadow="false" data-tolerance="0,0">
    <br/>
    <button data-theme="a" data-icon="search" data-mini="true" onclick="alert('TODO: nodig?')">Zoek video</button>
    <button data-theme="a" data-icon="grid" data-mini="true" onclick="alert('TODO: toon huidig scherm in edit mode, incl lijst van beschikbare kanalen')">Kanelen aan / uit</button>
    <!--button data-theme="a" data-icon="info" data-mini="true" href="#about" data-transition="pop">Over Game TV</button-->
    <a data-role="button" data-theme="a" data-icon="info" data-mini="true" href="#about" data-transition="flip">Over Game TV</a>
    <button data-theme="c" data-icon="delete" data-mini="true" onclick="$('#popupPanel').popup('close')">Sluiten</button>
  </div>

  <div data-role="content">
    <div class="content-primary">
      <div class="antenna"></div>
      <ul id="videosourceList" data-role="listview" data-inset="true"></ul>
    </div>
  </div>

  <div class="feedback"></div>

</div>


<!-- PAGE 2 -->
<div data-role="page" id="videos">

  <div data-role="header" data-position="fixed">
    <a href="#videosources" data-icon="arrow-l" data-direction="reverse">terug</a>
    <h1><!-- filled when loaded --></h1>
  </div>

  <div data-role="content">
    <div class="content-primary">
      <div class="antenna"></div>
      <ul id="videoList" data-role="listview" data-inset="true"></ul>
    </div>
  </div>

  <div class="feedback"></div>

</div>


<!-- PAGE 3: about -->
<div data-role="page" id="about">

  <div data-role="header" data-position="fixed">
    <a href="#videosources" data-icon="arrow-l" data-transition="flip" data-direction="reverse">terug</a>
    <h1>Over Game TV</h1>
  </div>

  <div data-role="content">
    <div class="content-primary">
      <div class="antenna"></div>
      <ul data-role="listview" data-inset="true">
        <li>
          <h3>Game TV is een product van X-Services.nl</h3>
          <p>TODO: Iets over de app en de content.</p>
        </li>
        <li>
          <a href="#" rel="external" onclick="redirectToAppStore()" data-icon="star">
            <h3>Beoordeel deze app</h3>
            <p>Geef je (on)gezoute mening in de appstore.</p>
          </a>
        </li>
      </ul>
    </div>
  </div>
  </div>



<!-- PAGE 4: player -->
  <div data-role="page" id="videoplayer">

  <div data-role="header" data-position="fixed">
    <a href="#videos" data-icon="arrow-l" data-transition="slide" data-direction="reverse">terug</a>
    <h1><!-- filled when loaded --></h1>
  </div>

    <div data-role="popup" id="share" data-theme="a" class="ui-corner-all">
      <form>
        <div style="padding:10px 20px;">
          <h3>Mail een vriend</h3>
          <label for="mailbody" class="ui-hidden-accessible">Tekst:</label>
          <textarea name="mailbody" id="mailbody" data-theme="a"></textarea>
          <a data-icon="arrow-r" data-role="button" data-theme="b" onclick="$('#share').popup('close'); redirect('mailto:?subject=Leuke video gezien op Game TV voor Android&body='+document.getElementById('mailbody').innerHTML); return false">Naar verzenden</a>
        </div>
      </form>
    </div>

  <div data-role="content">
    <div class="content-primary" style="text-align: center">

      <div class="ui-grid-a">
      	<div class="ui-block-a">
          <div class="antenna"></div>
          <video style="border:1px solid black" width="95%" src="replaced-by-videourl" type="video/mp4" autobuffer controls poster=""><!--  poster="img/back.png" -->
            <object classid="clsid:02bf25d5-8c17-4b23-bc80-d3488abddc6b" width="50%" codebase="http://www.apple.com/qtactivex/qtplugin.cab">
              <param value="replaced-by-videourl" type="video/mp4">
              <param value="true">
              <param value="false">
              <embed src="replaced-by-videourl" type="video/mp4" width="95%" autoplay="true" controller="false" pluginspage="http://www.apple.com/quicktime/download/"></embed>
            </object>
          </video>
      	</div>
      	<div class="ui-block-b">
          <div id="description"></div>
          <br/><a data-role="button" data-inline="true" data-mini="true" data-icon="forward" href="#share" data-rel="popup" data-transition="flip" data-position-to="window">deel deze video</a>
      	</div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
