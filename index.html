<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no">
  <title>Game TV</title>
  <link rel="stylesheet" href="css/themes/default/jquery.mobile-1.4.0-rc.1.min.css" type="text/css"/>
  <link rel="stylesheet" href="css/gametv.custom.css" type="text/css"/>
  <link rel="stylesheet" href="font-awesome/css/font-awesome.min.css" type="text/css">
  <link rel="apple-touch-icon" href="icon.png"/><!-- for webapp usage (not intended btw, but is possible) -->
  <script src="js/lib/jquery-1.10.2.min.js"></script>
  <script src="js/lib/fastclick.js"></script>
  <script src="js/gametv.custom.js"></script>
  <script src="js/jqm-init.js"></script>
  <script src="js/lib/jquery.localisation.min.js"></script>
  <script src="js/lib/jquery.mobile-1.4.0-rc.1.min.js"></script>
  <script src="js/lib/jqm.page.params.js"></script>
  <script src="http://www.youtube.com/iframe_api" async="async" defer="defer"></script>
  <script src="js/pushclient.js"></script>
  <script src="phonegap.js"></script>
  <script src="GAPlugin.js"></script>
  <script src="PushNotification.js"></script>
  <script src="js/plugins/SocialSharing.js"></script>
  <script type="text/javascript">
    "use strict";
    $(document).ready(function() {
      increaseNrOfAppStarts();
      // init phonegap
      if (isMobileWithPhonegap()) {
        document.addEventListener('deviceready', onDeviceReady, false);
      } else {
        onDeviceReady();
      }
      FastClick.attach(document.body);
      $.mobile.defaultHomeScroll = 0;
      $("[data-role='header']").toolbar();
    });

    // Google Analytics: webprofiel is gamekings, plugin is gametv.. en op x-services is het het webprofiel van gametv
    var gaPlugin;
    var _gaq = _gaq || [];

    function onDeviceReady() {
      document.addEventListener("backbutton", onBackButtonPressed, false);
      document.addEventListener("resume", onResume, false);
      if (window.plugins != undefined) {
        gaPlugin = window.plugins.gaPlugin;
        gaPlugin.init(gaInitSuccessHandler, gaInitErrorHandler, "UA-28850866-4", 8);
        new PushClient("44561589632", onReceivePushRegistrationID, onReceiveMessage);

        // init GameKings profile
        _gaq.push(['_setAccount', 'UA-1923358-6']);
        (function() {
          var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
      } else if (isDomainXServicesNL()) {
        // custom GA (for clients accessing www.x-services.nl/gametv)
        _gaq.push(['_setAccount', 'UA-28850866-4']);
        (function() {
          var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
      }
      if (navigator.splashscreen != undefined) {
        navigator.splashscreen.hide();
      }
    }

    function onReceivePushRegistrationID(regid) {
      setPushRegistrationID(regid);
      $.getJSON(getServiceURL("/push/registerunique/"+regid+"/"+(isAndroid()?"ANDROID":"IOS")+"/"+device.uuid));
      googleAnalytics("push-registrationid");
    }

    function onReceiveMessage(message) {
      // maybe the best is to do nothing
//      alert("msg: " + message);
//      $.mobile.changePage('#videos?videosourceid=' + videosource.id + '&videosourcename='+encodeURI(videosource.name.replace(".","_"))+', {transition: 'none'});
      googleAnalytics("push-message");
    }

    function gaInitSuccessHandler() {
    }

    function gaInitErrorHandler() {
    }

    function gaPluginResultHandler() {
    }

    function gaPluginErrorHandler() {
    }

    function googleAnalytics(page) {
      if (gaPlugin !== undefined && isMobileWithPhonegap()) {
        gaPlugin.trackPage(gaPluginResultHandler, gaPluginErrorHandler, page);
      } else if (isDomainXServicesNL()) {
        _gaq.push(['_trackPageview', page]);
      }
    }

    function googleAnalyticsGamekings(page) {
      if (isMobileWithPhonegap()) {
        _gaq.push(['_trackPageview', page]);
      }
    }

    function isDomainXServicesNL() {
      return location.hostname.indexOf("x-services.nl") > -1;
    }

    // The Android backbutton should just do the same as clicking the backbutton in the header
    function onBackButtonPressed() {
      if ($.mobile.activePage[0].id == "videosources") {
        navigator.app.exitApp();
      } else {
        $('#fixedToolbar')
            .find('.ui-btn-left') // the left button is always 'back' or 'cancel'
            .trigger('click');
      }
    }

    function onResume() {
      if ($.mobile.activePage[0].id == "videosources") {
        loadVideos();
      } else {
        forceLoad = true;
      }
    }

    // kick off localisation
    var lang = $.localise.defaultLanguage;
    $.localise('js/localisation/messages', {language: lang, loadBase: true});

    function renderVideoSourceList(videosources) {
      var htmlVideosource = '' +
          '<li data-role="list-divider" id="page_home_channellist_header"></li>';
      $.each(videosources, function (i, videosource) {

        if (videosource.videoList.length > 0 && isEnabledForUser(videosource.id)) { // no empty channels and only active sources

          htmlVideosource += '' +
              '<li>' +
              '  <a href="#videos?videosourceid=' + videosource.id + '&videosourcename='+encodeURI(videosource.name.replace(".","_"))+'">' +
              '    <img class="videosource-image" src="'+getEndpoint()+'/public/images/videosources/gametv/' + videosource.image + '" />' +
              '    <h3>' + videosource.name +'</h3>' +
              '    <p><img src="'+getEndpoint()+'/public/images/flags/' + videosource.country + '.png" width="11px" height="7px"/>&nbsp;&nbsp;&nbsp;' + getDateString(videosource.videoList[0].date, lang) + '</p>';
          var nrOfNewVids = nrOfNewVideos(videosource.id);
          if (nrOfNewVids > 0) {
            htmlVideosource += '<span class="ui-li-count">' + nrOfNewVids + '</span>';
          }
          var nrRec = nrOfRecommendedVideos(videosource.videoList);
          if (nrRec > 0) {
            htmlVideosource += '<span class="ui-li-count recommendations"><i class="icon-star"> <span class="fontawesome-corrected">' + nrRec + '</span></i></span>';
          }
          htmlVideosource +=
              '  </a>' +
              '</li>';
        }
      });
      $("#videosources .antenna").show();
      $("#videosourceList").html(htmlVideosource);
      $("#page_home_channellist_header").html(page_home_channellist_header);
      $("#videosourceList").listview('refresh');
    }

    function nrOfNewVideos(videosourceid) {
      var items = sessionStorage.getItem("newVideosForSource_"+videosourceid);
      return items == null ? 0 : JSON.parse(items).length;
    }

    function nrOfRecommendedVideos(videos) {
      var total = 0;
      for (var i=0; i<videos.length; i++) {
        total += videos[i].nrofrecommendations;
      }
      return total;
    }

    function isEnabledForUser(videosourceid) {
      return localStorageObjectContainsID("disabledVideosources", videosourceid);
    }

    function toggleRecommendationLocally(videosourceid, videoid, on) {
      var videosources = JSON.parse(localStorage.getItem("videosources"));
      $.each(videosources, function (i, videosource) {
        if (videosourceid == videosource.id) {
          $.each(videosource.videoList, function (i, video) {
            if (video.id == videoid) {
              if (on) {
                video.nrofrecommendations++;
              } else {
                video.nrofrecommendations--;
              }
              localStorage.setItem("videosources", JSON.stringify(videosources));
              return false; // break
            }
          })
        }
      })
    }

    function increaseNrOfViewsLocally(videosourceid, videoid) {
      var videosources = JSON.parse(localStorage.getItem("videosources"));
      $.each(videosources, function (i, videosource) {
        if (videosourceid == videosource.id) {
          $.each(videosource.videoList, function (i, video) {
            if (video.id == videoid) {
              video.nrofviews++;
              localStorage.setItem("videosources", JSON.stringify(videosources));
              return false; // break
            }
          })
        }
      })
    }

    function saveVideosources() {
      var disabledVideosources = [];
      var disabledVideosourcesForPush = [];
      var enabledVideosourcesForPush = [];
      var videosources = JSON.parse(localStorage.getItem("videosources"));
      $.each(videosources, function (i, videosource) {
        if (!$("#editvideosourcesForm #checkbox-on-"+videosource.id).is(":checked")) {
          disabledVideosources.push(videosource.id);
        }
        if (getPushRegistrationID() != null) {
          if ($("#editvideosourcesForm #checkbox-push-"+videosource.id).is(":checked")) {
            enabledVideosourcesForPush.push(videosource.id);
          } else {
            disabledVideosourcesForPush.push(videosource.id);
          }
        }
      });
      localStorage.setItem("disabledVideosources", JSON.stringify(disabledVideosources));
      if (getPushRegistrationID() != null) {
        localStorage.setItem("disabledVideosourcesForPush", JSON.stringify(disabledVideosourcesForPush)); // note: no longer used on the edit page (uses server), only for checking if the homepage notification should be shown
        $.getJSON(getServiceURL("/push/registersub/"+getPushRegistrationID()+"/"+JSON.stringify(enabledVideosourcesForPush)));
      }
      // re-render the list
      renderVideoSourceList(videosources);
      // back to the list
      $.mobile.changePage($("#videosources"), {reverse:true});
    }

    function userHasRecommended(videoid) {
      var recommendedVideos = localStorage.getItem("recommendedVideos");
      return recommendedVideos != null && $.inArray(videoid, JSON.parse(recommendedVideos)) > -1;
    }

    function renderVideoList(videosourceid) {
      var cachedVideos = localStorage.getItem("videosources");
      var videosources = JSON.parse(cachedVideos);

      // find the correct videosource in the cache
      $.each(videosources, function (i, videosource) {
        if (videosource.id == videosourceid) {
          // set the header
          $("#videos h1").html(videosource.name);
          // render the videolist
          var htmlVideo = '';
          var newVideoIDs = null;
          if (nrOfNewVideos(videosource.id) > 0) {
            newVideoIDs = JSON.parse(sessionStorage.getItem("newVideosForSource_"+videosourceid));
          }
          var previousDateString = null;
          $.each(videosource.videoList, function (j, video) {
            var dateString = getDateString(video.date, lang);
            if (previousDateString == null || dateString != previousDateString) {
              htmlVideo += '' +
                  '<li data-role="list-divider">' + dateString + '</li>';
            }
            htmlVideo += '' +
                '<li>' +
                '  <a href="#videoplayer?videosourceid='+videosource.id+'&videoid='+video.id+'&videosourcename='+videosource.name+'">' +
                '    <img class="video-image" src="' + video.imageurl + '" />' +
                '    <h3';
            if (newVideoIDs != null && $.inArray(video.pageurl, newVideoIDs) > -1) {
              htmlVideo += ' class="ui-li-heading-unseen"';
            }
            htmlVideo += '>' + video.title + '</h3>';
            htmlVideo += '<p>';
            if (video.nrofviews > 0) {
              htmlVideo += '<span class="nrOfViews"><i class="icon-play"> <span class="fontawesome-corrected">'+video.nrofviews+'</span></i></span>';
            }
            if (video.nrofrecommendations > 0) {
              htmlVideo += '<span class="ui-li-count recommendations"><i class="icon-star"> ' + video.nrofrecommendations + '</i></span>';
            }
            if (video.description !== undefined) {
              htmlVideo += video.description;
            }
            htmlVideo +=
                '    </p>' +
                '  </a>' +
                '</li>';
            previousDateString = dateString;
          });

          $("#videos .antenna").show();
          $("#videoList")
              .html(htmlVideo)
              .listview('refresh');
          $("#website").html("&copy; " + videosource.website);
          $.mobile.loading('hide');

          //  break the loop
          return false;
        }
      })
    }

  function updateHeader(title, left, right) {
    var toolbar = $("#fixedToolbar");
    $(toolbar).find("h1").html(title);
    if (left === undefined) {
      $(toolbar).find(".ui-btn-left").hide();
    } else {
      $(toolbar).find(".ui-btn-left").replaceWith(left).show();
    }
    if (right === undefined) {
      $(toolbar).find(".ui-btn-right").hide();
    } else {
      $(toolbar).find(".ui-btn-right").replaceWith(right).show();
    }
  }
  </script>
</head>
<body>




<!-- extracted header from the page templates, to make them truly persistent
     (view-source:http://view.jquerymobile.com/1.4.0-rc.1/dist/demos/toolbar-fixed-persistent/) -->
<div id="fixedToolbar" data-role="header" data-theme="b" data-tap-toggle="false" data-position="fixed">
  <a data-icon="refresh" class="ui-btn-left ui-nodisc-icon ui-link ui-btn ui-icon-bars ui-btn-icon-notext ui-shadow ui-corner-all" href="#" data-iconpos="notext" onclick="loadVideos()" data-role="button" role="button"></a>
  <h1>Game TV</h1>
  <a data-icon="bars" data-iconpos="notext" href="#" onclick="$.mobile.changePage('#editvideosources')" data-role="button" data-direction="reverse" class="ui-btn-right ui-nodisc-icon ui-link ui-btn ui-icon-bars ui-btn-icon-notext ui-shadow ui-corner-all" role="button"></a>
</div>



<!-- PAGE: videosources -->
<div data-role="page" id="videosources" class="videosourcespage">
  <script type="text/javascript">
    var forceLoad = true;
    $('#videosources')
        .on('pagebeforeshow', function(e, data) {
          updateHeader(
              "Game TV",
              '<a data-icon="refresh" class="ui-btn-left ui-nodisc-icon" href="#" data-iconpos="notext" onclick="loadVideos()"></a>',
              '<a data-icon="bars" data-iconpos="notext" href="#" onclick="$.mobile.changePage(\'#editvideosources\')" data-role="button" data-direction="reverse" class="ui-btn-right ui-nodisc-icon"></a>');
        })
        .on('pageshow', function(e, data) {
          googleAnalytics("videosources");
          var fromVideosourceid = data.prevPage.attr('data-videosourceid');
          if (!isNaN(fromVideosourceid)) {
            // set all videos as seen for this source
            if (nrOfNewVideos(fromVideosourceid) > 0) {
              sessionStorage.setItem("newVideosForSource_"+fromVideosourceid, JSON.stringify([]));
            }
          }
          if (forceLoad) {
            loadVideos();
            forceLoad = false;
          }
        });

    function getNewVideoIDs(idContainerOldList, idContainerNewList) {
      var newList = [];
      $.each(idContainerNewList, function (i, idContainerNew) {
        var found = false;
        $.each(idContainerOldList, function (j, idContainerOld) {
          // compare the unique pageurls, so counts are ok when the server restarts
          if (idContainerNew.pageurl == idContainerOld.pageurl) {
            found = true;
          }
        });
        if (!found) {
          newList.push(idContainerNew.pageurl);
        }
      });
      return newList;
    }

    function loadVideos() {
      $.mobile.loading('show');
      // timeout, so the spinner can load
      setTimeout(function(){
        var cachedVideosourcesString = localStorage.getItem("videosources");
        var cachedVideosources = null;
        if (cachedVideosourcesString != null) {
          cachedVideosources = JSON.parse(cachedVideosourcesString);
          renderVideoSourceList(cachedVideosources);
        }

        $.getJSON(getServiceURL("/videosource/client/gametv/" + (isAndroid() ? "android" : (isFireFoxOS() ? "firefoxos" : "ios"))))
            .success(function (newVideosources) {
              var newVideosourcesString = JSON.stringify(newVideosources);
              if (cachedVideosources != null) {
                // count the number of new videos per source, compared to the cachedvideos
                $.each(newVideosources, function (i, newVideosource) {
                  $.each(cachedVideosources, function (j, cachedVideosource) {
                    if (newVideosource.id == cachedVideosource.id) {
                      var newVideoIDsForThisVideosource = getNewVideoIDs(cachedVideosource.videoList, newVideosource.videoList);
                      sessionStorage.setItem("newVideosForSource_"+newVideosource.id, JSON.stringify(newVideoIDsForThisVideosource));
                    }
                  })
                })
              }

              sessionStorage.setItem("videosources", newVideosourcesString);
              localStorage.setItem("videosources", newVideosourcesString);
              renderVideoSourceList(newVideosources);
              renderHomepageNotifications();
              $.mobile.loading('hide');
            })
            .error(function () {
              if (cachedVideosourcesString == null) {
                $(".feedback").html("Well, there was an error loading the videos from the server. Please try again later..");
              } else {
  //              $(".feedback").html("Failed to fetch latest videos, showing the last known list.");
              }
              $.mobile.loading('hide');
            })
      }, 250);
    }

    function renderHomepageNotifications() {
      // don't show the pushnotification notification (lol) on first start
      if (localStorage.getItem("videosources") != null) {
        // only show this notification if no pushes have been configured
        if (localStorage.getItem("disabledVideosourcesForPush") == null && isMobileWithPhonegap()) {
          $("#notification").html(getNotification('homepage_pushconfighint'));
        } else if (getNrOfAppStarts() > 6 && isAndroid()) {
          $("#notification").html(getNotification('homepage_begforreview_android'));
        }
        // for non-app visitors.. this may be interesting
        if (!isMobileWithPhonegap()) {
          $("#notification").css({'text-align':'right'}).html('<br/><br/><a href="http://play.google.com/store/apps/details?id=nl.x_services.gametv"><img src="http://developer.android.com/images/brand/en_generic_rgb_wo_45.png" alt="Game TV Android app in the Play Store" />');
        }
      }
    }
  </script>

  <div data-role="content">
    <div class="content-primary">
      <div class="antenna"></div>
      <ul id="videosourceList" data-role="listview" data-inset="true"></ul>
    </div>
    <div id="notification"></div>
  </div>
  <div class="feedback"></div>
</div>



<!-- PAGE: edit videosources -->
<div data-role="page" id="editvideosources" class="videosourcespage">
  <script type="text/javascript">
    $('#editvideosources')
        .on('pagebeforeshow', function (e, data) {
          updateHeader(
              page_editvideosources_title,
              '<a class="ui-nodisc-icon" href="#videosources" data-iconpos="notext" data-role="button" data-direction="reverse" data-icon="delete" id="page_editvideosources_button_cancel"></a>',
              '<a data-icon="check" class="ui-nodisc-icon" data-role="button" data-iconpos="notext" class="ui-btn-right"  data-iconpos="right" href="#" onclick="saveVideosources()" id="page_editvideosources_button_save"></a>');
        })
        .on('pageshow', function (e, data) {
          $.mobile.loading('show');
          setTimeout(function() {
            googleAnalytics("editvideosources");

            if (getPushRegistrationID() == null) {
              renderEditVideoSourceList(JSON.parse(localStorage.getItem("videosources")), []);
            } else {
              $.getJSON(getServiceURL("/push/getsubs/"+getPushRegistrationID()))
                  .success(function (videoSourcePushSubscriptions) {
                    renderEditVideoSourceList(JSON.parse(localStorage.getItem("videosources")), videoSourcePushSubscriptions);
                  })
                  .error(function() {
                    renderEditVideoSourceList(JSON.parse(localStorage.getItem("videosources")), []);
                  });
            }

//            $("#page_editvideosources_button_cancel").html(page_editvideosources_button_cancel);
//            $("#page_editvideosources_button_save").html(page_editvideosources_button_save);
          }, 200)
        });


    function renderEditVideoSourceList(videosources, videoSourcePushSubscriptions) {
      var htmlVideosource = '';

      // first sort by country, done by creating an associative array of arrays
      var sortedVideosources = {};
      $.each(videosources, function (i, videosource) {
        var country = videosource.country;
        var channelsInCountry = sortedVideosources[country];
        if (channelsInCountry === undefined) {
          sortedVideosources[country] = [];
        }
        var x = sortedVideosources[country];
        x.push(videosource);
        sortedVideosources[country] = x;
      });

      // and now render the list
      $.each(sortedVideosources, function (i, videosourcesForCountry) {
        htmlVideosource += '<li data-role="list-divider"><span><img src="'+getEndpoint()+'/public/images/flags/' + i + '.png" width="22px" height="14px"/>&nbsp;&nbsp;&nbsp;<span class="country_name">' + eval("country_"+i) + '</span></span></li>';

        $.each(videosourcesForCountry, function (j, videosource) {
          if (videosource.videoList.length > 0) { // no empty channels
            htmlVideosource += '' +
                '<li data-role="fieldcontain">' +
                '  <img class="videosource-image" src="'+getEndpoint()+'/public/images/videosources/gametv/' + videosource.image + '" />' +
                '  <div class="ui-grid-a">' +
                '    <div class="ui-block-a">' +
                '      <h3>' + videosource.name + '</h3>' +
                '      <p>' + videosource.website + '</p>' +
                '    </div>' +
                '    <div class="ui-block-b">' +
                '      <fieldset data-role="controlgroup" data-iconpos="right">' +
                '        <input type="checkbox" name="checkbox-on-'+videosource.id+'" id="checkbox-on-'+videosource.id+'" '+(isEnabledForUser(videosource.id) ? 'checked' : '')+' data-mini="true">' +
                '        <label class="showcheckbox" for="checkbox-on-'+videosource.id+'"></label>';
            if (isMobileWithPhonegap()) {
              var hasPushSubscriptionForVideoSource = $.inArray(videosource.id, videoSourcePushSubscriptions) > -1;
              htmlVideosource += '' +
                  '        <input type="checkbox" name="checkbox-push-'+videosource.id+'" id="checkbox-push-'+videosource.id+'" '+(hasPushSubscriptionForVideoSource ? 'checked' : '')+' data-mini="true">' +
                  '        <label class="pushcheckbox" for="checkbox-push-'+videosource.id+'"></label>';
            }
            htmlVideosource += '' +
                '      </fieldset>' +
                '    </div>' +
                '  </div>' +
                '</li>';
          }
        });
      });

      $("#videosourceListFull")
          .html(htmlVideosource)
          .listview('refresh');

      $('.ui-block-b').trigger("create");
      $(".ui-block-b .showcheckbox").html(page_editvideosources_checkbox_channel);
      $(".ui-block-b .pushcheckbox").html(page_editvideosources_checkbox_push);
      $.mobile.loading('hide');
    }
  </script>

  <div data-role="content">
    <div class="content-primary">
      <form id="editvideosourcesForm">
        <div class="antenna"></div>
        <ul id="videosourceListFull" data-role="listview" data-inset="true"></ul>
      </form>
    </div>
  </div>
</div>


<!-- PAGE: videos -->
<div data-role="page" id="videos" data-videosourceid="to-be-filled">
  <script type="text/javascript">
    $('#videos')
        .on('pagebeforeshow', function (e, data) {
          updateHeader(
              unescape($.mobile.pageData.videosourcename),
              '<a href="#videosources" class="ui-nodisc-icon" data-iconpos="notext" data-icon="arrow-l" data-direction="reverse" class="button_back"></a>');
        })
        .on('pageshow', function (e, data) {
          if ($.mobile.pageData != null) {
            var videosourceid = $.mobile.pageData.videosourceid;
            if (videosourceid != null) {
              // remember the videosource, used when going back to videosourcelist
              $('#videos').attr('data-videosourceid', videosourceid);
              // show a spinner while loading the content
              $.mobile.loading('show');
              setTimeout(function() {
                renderVideoList(videosourceid);
              }, 250);
            }
            var videosourcename = $.mobile.pageData.videosourcename;
            googleAnalytics("videos/"+videosourcename);
          }
        })
        .on('pagebeforehide', function (e, data) {
          // clear the page for the next visit, but only when navigating to the videosources page
          if ($.mobile.pageData == null) {
            $("#videos #videoList").html("");
            $("#videos #website").html("");
            $("#videos .antenna").hide();
          }
        });
  </script>

  <div data-role="content">
    <div class="content-primary">
      <div class="antenna"></div>
      <ul id="videoList" data-role="listview" data-inset="true"></ul>
    </div>
    <div id="website"></div>
  </div>
</div>



<!-- PAGE: videoplayer -->
  <div data-role="page" id="videoplayer">
    <script type="text/javascript">
      $('#videoplayer')
          .on('pagebeforeshow', function (e, data) {
            $('#videocontainer').html('<div id="player"></div>');
          })
          .on('pageshow', function (e, data) {
            googleAnalytics("videoplayer");
            var videosourceid = $.mobile.pageData.videosourceid;
            var videosourcename = $.mobile.pageData.videosourcename;
            var videoid = $.mobile.pageData.videoid;
            var cachedVideos = localStorage.getItem("videosources");
            var videosources = JSON.parse(cachedVideos);
            // find the correct videosource in the cache
            $.each(videosources, function (i, videosource) {
              if (videosource.id == videosourceid) {
               // find the correct video in the cache
                $.each(videosource.videoList, function (i, video) {
                  if (video.id == videoid) {
                    updateHeader(
                        unescape(video.title),
                        '<a href="#videos?videosourcename='+videosourcename+'" class="ui-nodisc-icon" data-iconpos="notext" data-icon="arrow-l" data-direction="reverse" class="button_back"></a>');

                    renderVideoPlayer(videosourceid, video);
                    registerVideoShown(video.id);
                    // set video as seen if applicable
                    if (nrOfNewVideos(videosourceid) > 0) {
                      var newVideoIDs = JSON.parse(sessionStorage.getItem("newVideosForSource_"+videosourceid));
                      var index = $.inArray(video.pageurl, newVideoIDs);
                      if (index > -1) {
                        // remove from array and store (remove 1 item, starting at the index of the item found)
                        newVideoIDs.splice(index, 1);
                        sessionStorage.setItem("newVideosForSource_"+videosourceid, JSON.stringify(newVideoIDs));
                      }
                    }
                    increaseNrOfViewsLocally(videosourceid, videoid);
                    // re-render the previous page
                    renderVideoList(videosourceid);
                    if (videosource.name == "Gamekings") {
                      googleAnalyticsGamekings(video.pageurl);
                    }
                    return false; // breaks the inner loop
                  }
                });
                return false; // breaks the outer loop
              }
            });
            $.mobile.loading('hide');
          })
          .on('pagebeforehide', function (e, data) {
            // clear the page for the next visit.. also forces the video to stop playing
            $("#videoplayer #videocontainer").html("");
            $("#videoplayer #description").html("");
            $("#videoplayer #recommended").hide();
            $("#videoplayer #recommend").hide();
            $("#videoplayer #share").hide();
          });

      function showRecommendButtons(pvideosourceid, pvideoid) {
        // remember the video
        $("#videoplayer #recommend").attr('data-videoid', pvideoid);
        $("#videoplayer #recommend").attr('data-videosourceid', pvideosourceid);
        $("#videoplayer #recommended").attr('data-videoid', pvideoid);
        $("#videoplayer #recommended").attr('data-videosourceid', pvideosourceid);
        // toggle the correct state
        if (userHasRecommended(pvideoid)) {
          $("#videoplayer #recommend").hide();
          $("#videoplayer #recommended").show();
        } else {
          $("#videoplayer #recommend").show();
          $("#videoplayer #recommended").hide();
        }
        // add behaviour
        $("#recommend")
            .unbind('click')
            .bind('click', function() {
              var videoid = parseInt($(this).attr("data-videoid"));
              var videosourceid = parseInt($(this).attr("data-videosourceid"));
              registerVideoRecommended(videoid);
              var recommendedVideos = localStorage.getItem("recommendedVideos");
              if (recommendedVideos == null) {
                recommendedVideos = [];
              } else {
                recommendedVideos = JSON.parse(recommendedVideos);
              }
              recommendedVideos.push(videoid);
              localStorage.setItem("recommendedVideos", JSON.stringify(recommendedVideos));
              toggleRecommendationLocally(videosourceid, videoid, true);
              $("#videoplayer #recommend").hide();
              $("#videoplayer #recommended").show();
              // re-render the previous page, so the smiley is shown
              renderVideoList(videosourceid);
            });
        $("#recommended")
            .unbind('click')
            .bind('click', function() {
              var videoid = parseInt($(this).attr("data-videoid"));
              var videosourceid = parseInt($(this).attr("data-videosourceid"));
              deregisterVideoRecommended(videoid);
              var recommendedVideos = localStorage.getItem("recommendedVideos");
              if (recommendedVideos != null) {
                recommendedVideos = JSON.parse(recommendedVideos);
                var curIndex = recommendedVideos.indexOf(videoid);
                recommendedVideos = recommendedVideos.slice(curIndex,1);
                localStorage.setItem("recommendedVideos", JSON.stringify(recommendedVideos));
                toggleRecommendationLocally(videosourceid, videoid, false);
              }
              $("#videoplayer #recommended").hide();
              $("#videoplayer #recommend").show();
              // re-render the previous page, so the smiley is shown
              renderVideoList(videosourceid);
            });
      }

      function registerVideoShown(videoid) {
        $.getJSON(getServiceURL("/video/watched/"+videoid));
      }

      function registerVideoRecommended(videoid) {
        googleAnalytics("recommend");
        $.getJSON(getServiceURL("/video/recommend/"+videoid));
      }

      function deregisterVideoRecommended(videoid) {
        googleAnalytics("unrecommend");
        $.getJSON(getServiceURL("/video/unrecommend/"+videoid));
      }

      function renderVideoPlayer(videosourceid, video) {
        // render the player
        $("#videoplayer video").attr("poster", video.imageurl);

        var totalWidth = $("body").width();
        var totalHeight = $("body").height();
        var height = (totalWidth / (totalWidth < totalHeight ? 2 : 3));
        var width = "100%";

        var videourl = video.videourl;

        // making the page load more smoothly by delaying the rendering of the player
        if (isYouTube(videourl)) {
          // set the video quality
//          var videoquality = "small"; // default
//          var preferedVideoquality = localStorage.getItem("videoQuality");
//          if (preferedVideoquality != null) {
//            videoquality = preferedVideoquality;
//          }
          loadYoutubeVideoplayer(videourl, width, height);
          /*
          $("#videoqualitySwitch")
              .show()
              .find("input[type='radio']")
              .bind("change", function(event, ui) {
                var switchedTo = $(this).val();
                $("#youtubeFrame").attr('src', videourl+'?autoplay=1&hd=1&vq='+switchedTo+'&autoplay=true&modestbranding=1&rel=0&showinfo=0');
                setVideoQualitySwitch(switchedTo);
                localStorage.setItem("videoQuality", switchedTo);
              });
          setVideoQualitySwitch(videoquality);
          */
        } else {
//          $("#videoqualitySwitch").hide();
//          if (isIOS()) {
//            width = "95%";
//          }
          $("#videocontainer").html('\
              <video style="z-index:1008" width="'+width+'" height="'+height+'" src="'+videourl+'" type="video/mp4" preload="auto" controls poster="'+video.imageurl+'">\
                <object classid="clsid:02bf25d5-8c17-4b23-bc80-d3488abddc6b" width="'+width+'" height="'+height+'" codebase="http://www.apple.com/qtactivex/qtplugin.cab">\
                  <param value="'+videourl+'" type="video/mp4">\
                  <embed src="'+videourl+'" type="video/mp4" width="'+width+'" height="'+height+'" controller="false" pluginspage="http://www.apple.com/quicktime/download/"></embed>\
                </object>\
              </video>');
        }

        if (video.description) {
          $("#videoplayer #description").html(video.description + (video.description.length == 420 ? ".." : "")); // TODO serverfix & remove any links and images!
        } else {
          $("#videoplayer #description").html(video.title);
        }

        showRecommendButtons(videosourceid, video.id);

        if (isMobileWithPhonegap()) {
          $("#share").show();
          $('#videoplayer #share').html('<i class="icon-share-sign" onclick="share(\''+video.title+' '+video.pageurl+' - via GameTV for Android\', \''+video.title+'\')"><span class="fontawesome-corrected"> share</span></i>');
        }
      }

      function share(msg, subject) {
        googleAnalytics("share");
        window.plugins.socialsharing.share(msg, subject);
      }

      function setVideoQualitySwitch(val) {
        var switchContainer = $("#videoqualitySwitch");
        $(switchContainer).find("label").removeClass("ui-btn-active");
        $(switchContainer).find('#radio-videoquality-'+val+'-label').addClass("ui-btn-active");
      }

      // TODO encapsulate in object
      var player;
      var playerwidth;
      var playerheight;
      var playervideourl;

      function loadYoutubeVideoplayer(videourl, width, height) {
        playerwidth = width;
        playerheight = height;
        playervideourl = videourl.substring(videourl.lastIndexOf('/')+1);
        loadYoutubeVideo();
      }

      function loadYoutubeVideo() {
        player = new YT.Player('player', {
          height: playerheight,
          width: playerwidth,
          videoId: playervideourl,
          playerVars: {
            autoplay: 1,
            controls: 1,
            rel: 0,
            modestbranding: 1
          },
          events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
          }
        })
      }

      function onPlayerReady(event) {
        event.target.setPlaybackQuality(getVideoQuality());
      }

      function onPlayerStateChange(event) {
        if (event.data == YT.PlayerState.BUFFERING) {
          event.target.setPlaybackQuality(getVideoQuality());
        }
      }

    function getVideoQuality() {
      if (navigator.connection == undefined /*desktop*/) {
        return "hd720";
      } else {
        var cnx = navigator.connection.type;
        if (cnx == Connection.WIFI || cnx == Connection.ETHERNET) {
          if ($("body").height() >= 720 || $("body").width() > 720) {
            return "hd720";
          } else {
            return "large";
          }
        } else if (cnx == Connection.CELL_4G) {
          return "large";
        } else if (cnx == Connection.CELL_2G) {
          return "small";
        } else {
          return "medium";
        }
      }
    }
    </script>

  <div data-role="content">
    <div class="content-primary" style="text-align: center">
      <div class="ui-grid-a">
      	<div class="ui-block-a">
          <div class="antenna"></div>
          <div id="videocontainer"></div><br/>
      	</div>
      	<div class="ui-block-b">
          <div id="description"></div><br/>
          <span class="ui-btn-inline" id="recommend" style="cursor: pointer"><i class="icon-star-empty"> <span class="fontawesome-corrected">tip</span></i></span>
          <span class="ui-btn-inline" id="recommended" style="cursor: pointer"><i class="icon-star"> <span class="fontawesome-corrected">tip</span></i></span>
          <span class="ui-btn-inline" id="share" style="cursor: pointer"></span>
          <br/>
      	</div>
      </div>
    </div>
  </div>
</div>

</body>
</html>