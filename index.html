<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=0"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <title>Game TV</title>
  <!-- NOTE: jqm loads the HEAD only once per session, so we need to include all css and js on every page (not only the first, because a reload of a page need to load all css/js as well) -->
  <link rel="stylesheet" href="js/lib/jquery.mobile-1.2.0/jquery.mobile-1.2.0.min.css"/>
  <link rel="stylesheet" href="js/lib/jquery.mobile-1.2.0/jquery.mobile.theme-1.2.0.min.css"/>
  <link rel="stylesheet" href="css/gametv.custom.css"/>
  <!--<link rel="stylesheet" href="css/index.css"/>-->
  <script src="js/lib/jquery.js"></script>
  <script src="js/gametv.custom.js"></script>
  <script src="js/jqm-init.js"></script>
  <script src="js/lib/jquery.mobile-1.2.0/jquery.mobile-1.2.0.min.js"></script>
  <script src="phonegap.js"></script>
  <!--<script src="js/index.js"></script>-->
  <script type="text/javascript">
    $(document).ready(function () {
      // if this is the first time (not returning from a video), load the list from the server
      if (sessionStorage.getItem("videosources") == null) {
        loadVideos();
      }
      // in case we're returning from a videoplayer, we need to go to the correct details page (otherwise the videosources are shown)
//      var videosourceid = getUrlParam("videosourceid");
//      if (videosourceid != null) {
//        $.mobile.changePage("#videos?videosourceid="+videosourceid);
//      }

      $('#videos').on('pagebeforeshow', function (e, data) {
        var videosourceid = getUrlParam("videosourceid");
        renderVideoList(videosourceid);
      });


      $("#popupPanel").on("popupbeforeposition", function() {
        $("#popupPanel").css("height", $(document).height());
      });

      $("#downloadApp").attr("href", isAndroid() ? "https://build.phonegap.com/apps/267637/download/android/?qr_key=sfqjvxAqyAAjSQvtB7pu" : "https://build.phonegap.com/apps/267637/download/ios/?qr_key=sfqjvxAqyAAjSQvtB7pu");
    });

    function loadVideos() {
      var cachedVideos = localStorage.getItem("videosources");
      if (cachedVideos != null) {
        renderVideoSourceList(JSON.parse(cachedVideos));
      }
      $.getJSON(getServiceURL("/videosource/all"))
          .success(function (data) {
            localStorage.setItem("videosources", JSON.stringify(data));
            renderVideoSourceList(data);
          })
          .error(function () {
            if (cachedVideos == null) {
              $(".feedback").html("Well, there was an error loading the videos from the server. Please try again later..");
            } else {
              $(".feedback").html("Failed to fetch latest videos, showing the last known list.");
            }
          })
    }

    function renderVideoSourceList(videosources) {
      var htmlVideosource = '';
      var htmlVideo = '';
      $.each(videosources, function (i, videosource) {

        // TODO: iCanHaz?
        htmlVideosource += '' +
            '<li>' +
            '  <a href="#videos?videosourceid=' + videosource.id + '" data-transition="slide">' +
            '    <img src="img/videosources/' + videosource.image + '" />' +
            '    <h3>' + videosource.name + '</h3>' +
            '    <p>' + videosource.website + '</p>' +
            '    <span class="ui-li-count">' + videosource.videoList.length + '</span>' + // TODO (later): show new-count
            '  </a>' +
            '</li>';
      });
      $("#videosourceList").html(htmlVideosource);
      $("#videosourceList").listview('refresh');

      $("#videoList").html(htmlVideo);
//      $("#videoList").listview('refresh');
    }

    function renderVideoList(videosourceid) {
      var cachedVideos = localStorage.getItem("videosources");
      var videosources = JSON.parse(cachedVideos);

      // find the correct videosource in the cache
      $.each(videosources, function (i, videosource) {
        if (videosource.id == videosourceid) {
          // set the header
          $("#videos h1").html(videosource.name);
          // render the videolist
          var htmlVideo = '';
          $.each(videosource.videoList, function (j, video) {
            var date = new Date(video.date);
            // TODO: iCanHaz?
            htmlVideo += '' +
                '<li>' +
                '  <a rel="external" href="' + video.videourl + '">' +
                '    <img src="' + video.imageurl + '" alt="' + video.title + '"/>' +
                '    <h3>' + video.title + '</h3>' +
                '    <p>' + date.getDate() + "-" + (date.getMonth() + 1) + "-" + date.getFullYear() + '</p>' +
                '  </a>' +
                '</li>';
          });

          $("#videoList").html(htmlVideo);
          $("#videoList").listview('refresh');

          //  break the loop
          return false;
        }
      })
    }
  </script>
</head>
<body>


<!-- PAGE 1 -->
<div data-role="page" id="videosources">

  <div data-role="header" data-position="fixed">
    <a id="downloadApp" data-icon="gear" href="#">update app</a>

    <h1>Kies een kanaal</h1>
    <a data-icon="grid" data-iconpos="right" href="#popupPanel" data-rel="popup" data-transition="slide" data-position-to="window">menu</a>
  </div>

  <div data-role="popup" id="popupPanel" data-corners="false" data-theme="none" data-shadow="false" data-tolerance="0,0">
    <br/>
    <br/>
    <button data-theme="a" data-icon="search" data-mini="true">Zoeken</button>
    <button data-theme="a" data-icon="grid" data-mini="true">Instellingen</button>
    <button data-theme="c" data-icon="delete" data-mini="true" onclick="$('#popupPanel').popup('close');">Sluiten</button>
  </div>

  <div class="feedback"></div>

  <div data-role="content">
    <div class="content-primary">
      <div class="antenna"></div>
      <ul id="videosourceList" data-role="listview" data-inset="true"></ul>
    </div>
  </div>
</div>


<!-- PAGE 2 -->
<div data-role="page" id="videos">

  <div data-role="header" data-position="fixed">
    <a href="#videosources" data-icon="arrow-l" data-direction="reverse">terug</a>
    <h1><!-- filled when loaded --></h1>
  </div>

  <div class="feedback"></div>

  <div data-role="content">
    <div class="content-primary">
      <div class="antenna"></div>
      <ul id="videoList" data-role="listview" data-inset="true"></ul>
    </div>
  </div>

</div>
</body>
</html>
