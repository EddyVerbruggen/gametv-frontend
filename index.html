<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no">
  <title>Game TV</title>
  <link rel="stylesheet" href="css/themes/default/jquery.mobile-1.3.1.min.css" type="text/css"/>
  <link rel="stylesheet" href="css/gametv.custom.css" type="text/css"/>
  <link rel="apple-touch-icon" href="icon.png"/><!-- for webapp usage (not intended btw, but is possible) -->
  <script src="js/lib/jquery-1.9.1.min.js"></script>
  <script src="js/gametv.custom.js"></script>
  <script src="js/jqm-init.js"></script>
  <script src="js/lib/jquery.localisation.min.js"></script>
  <script src="js/lib/jquery.mobile-1.3.1.min.js"></script>
  <script src="js/lib/jqm.page.params.js"></script>
  <!--link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Gudea:400,700,400italic" type="text/css"/-->
  <script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
  <!-- Included pgbuild js libs here. NOTE: debugging in Android emulator is not possible for PG features,
       BUT downloading the PG build APK on the emulator is! -->
  <script src="cordova.js"></script>
  <script src="GAPlugin.js"></script>
  <script src="childbrowser.js"></script>
  <script type="text/javascript">

    "use strict";
    $(document).ready(function() {

      // init phonegap
      if (isMobile()) {
        document.addEventListener('deviceready', onDeviceReady, false);
      } else {
        onDeviceReady();
      }

      // for Android 4.2 (and higher, but that's for a later day), set a css property for smooth animations
//      if (window.navigator.userAgent.indexOf("Android 4.2") > -1) {
//        $("div[data-role='page']").css({"-webkit-backface-visibility": "hidden"});
//      }
      // these swipes kill scrolling fluency on Android
//      $('#videos').bind('swiperight', function() {
//        $.mobile.changePage($("#videosources"), {reverse:true});
//      });
//      $('#videoplayer').bind('swiperight', function() {
//        $.mobile.changePage($("#videos"), {reverse:true});
//      });
    });

    // Google Analytics
    var gaPlugin;

    function onDeviceReady() {
      if (navigator.splashscreen != undefined) {
        navigator.splashscreen.hide();
      }
      if (window.plugins != undefined) {
        gaPlugin = window.plugins.gaPlugin;
        gaPlugin.init(gaInitSuccessHandler, gaInitErrorHandler, "UA-28850866-4", 5);
      }
    }

    function gaInitSuccessHandler() {
    }

    function gaInitErrorHandler() {
    }

    function gaPluginResultHandler() {
    }

    function gaPluginErrorHandler() {
    }

    function googleAnalytics(page) {
      if (gaPlugin !== undefined && isMobile()) {
        gaPlugin.trackPage(gaPluginResultHandler, gaPluginErrorHandler, page);
      }
    }

    // kick off localisation
    var lang = $.localise.defaultLanguage;
    $.localise('js/localisation/messages', {language: lang, loadBase: true});

    function renderVideoSourceList(videosources) {
      var htmlVideosource = '' +
          '<li data-role="list-divider" id="page_home_channellist_header"></li>';
      $.each(videosources, function (i, videosource) {

        if (videosource.videoList.length > 0 && isEnabledForUser(videosource.id)) { // no empty channels and only active sources

          htmlVideosource += '' +
              '<li>' +
              '  <a href="#videos?videosourceid=' + videosource.id + '&videosourcename='+encodeURI(videosource.name.replace(".","_"))+'">' +
              '    <img src="img/videosources/' + videosource.image + '" />' +
              '    <h3>' + videosource.name +'</h3>' +
//              '    <p><img src="img/flags/' + videosource.country + '.png" width="11px"/>&nbsp;&nbsp;&nbsp;' + videosource.website + '</p>';
              '    <p><img src="img/flags/' + videosource.country + '.png" width="11px"/>&nbsp;&nbsp;&nbsp;' + getDateString(videosource.videoList[0].date, lang) + '</p>';
          if (nrOfNewVideos(videosource.id) > 0) {
            htmlVideosource +=
                '    <span class="ui-li-count">' + nrOfNewVideos(videosource.id) + '</span>';
          }
          htmlVideosource +=
              '  </a>' +
              '</li>';
        }
      });
      $("#videosourceList").html(htmlVideosource);
      $("#page_home_channellist_header").html(page_home_channellist_header);
      $("#videosourceList").listview('refresh');
    }

    function nrOfNewVideos(videosourceid) {
      var items = sessionStorage.getItem("newVideosForSource_"+videosourceid);
      return items == null ? 0 : JSON.parse(items).length;
    }

    function isEnabledForUser(videosourceid) {
      var disabledVideosources = localStorage.getItem("disabledVideosources");
      if (disabledVideosources == null) {
        return true;
      } else {
        return $.inArray(videosourceid, JSON.parse(disabledVideosources)) == -1;
      }
    }

    function saveVideosources() {
      var disabledVideosources = [];
      var videosources = JSON.parse(localStorage.getItem("videosources"));
      $.each(videosources, function (i, videosource) {
        var sliderElementID = "#editvideosourcesForm #slider_"+videosource.id;
        var setting = $(sliderElementID).val();
        if (setting == "off") {
          disabledVideosources.push(videosource.id);
        }
      });
      localStorage.setItem("disabledVideosources", JSON.stringify(disabledVideosources));
      // re-render the list
      renderVideoSourceList(videosources);
      // back to the list
      $.mobile.changePage($("#videosources"), {reverse:true});
    }

    function renderVideoList(videosourceid) {
      var cachedVideos = localStorage.getItem("videosources");
      var videosources = JSON.parse(cachedVideos);

      // find the correct videosource in the cache
      $.each(videosources, function (i, videosource) {
        if (videosource.id == videosourceid) {
          // set the header
          $("#videos h1").html(videosource.name);
          // render the videolist
          var htmlVideo = '';
          var newVideoIDs = null;
          if (nrOfNewVideos(videosource.id) > 0) {
            newVideoIDs = JSON.parse(sessionStorage.getItem("newVideosForSource_"+videosourceid));
          }
          var previousDateString = null;
          $.each(videosource.videoList, function (j, video) {
            var dateString = getDateString(video.date, lang);
            if (previousDateString == null || dateString != previousDateString) {
              htmlVideo += '' +
                  '<li data-role="list-divider">' + dateString + '</li>';
            }
            htmlVideo += '' +
                '<li>' +
                '  <a href="#videoplayer?videosourceid='+videosource.id+'&videoid='+video.id+'">' +
                '    <img src="' + video.imageurl + '" />' +
                '    <h3';
            if (newVideoIDs != null && $.inArray(video.pageurl, newVideoIDs) > -1) {
              htmlVideo += ' class="ui-li-heading-unseen"';
            }
            htmlVideo += '>' + video.title + '</h3>';
            if (video.description !== undefined) {
              htmlVideo += '    <p>' + video.description + '</p>';
            }
            htmlVideo +=
                '  </a>' +
                '</li>';
            previousDateString = dateString;
          });

          $("#videoList")
              .html(htmlVideo)
              .listview('refresh');
          $("#website").html("&copy; " + videosource.website);

          //  break the loop
          return false;
        }
      })
    }
  </script>
</head>
<body>





<!-- PAGE: videosources -->
<div data-role="page" id="videosources" class="videosourcespage">
  <script type="text/javascript">
    $('#videosources')
        .on('pagebeforeshow', function(e, data) {
          googleAnalytics("videosources");
          var fromVideosourceid = data.prevPage.attr('data-videosourceid');
          if (!isNaN(fromVideosourceid)) {
            // set all videos as seen for this source
            if (nrOfNewVideos(fromVideosourceid) > 0) {
              sessionStorage.setItem("newVideosForSource_"+fromVideosourceid, JSON.stringify([]));
            }
          }
          loadVideos();
          $("#refresh_title .ui-btn-text").html(page_home_button_refresh);
          $("#menu_title .ui-btn-text").html(page_home_button_menu);
          $("#menu_option_editvideosources .ui-btn-text").html(menu_option_editvideosources);
          $("#menu_option_about .ui-btn-text").html(menu_option_about);
          $("#menu_option_close .ui-btn-text").html(menu_option_close);
        });

    function getNewVideoIDs(idContainerOldList, idContainerNewList) {
      var newList = [];
      $.each(idContainerNewList, function (i, idContainerNew) {
        var found = false;
        $.each(idContainerOldList, function (j, idContainerOld) {
          // compare the unique pageurls, so counts are ok when the server restarts
          if (idContainerNew.pageurl == idContainerOld.pageurl) {
            found = true;
          }
        });
        if (!found) {
          newList.push(idContainerNew.pageurl);
        }
      });
      return newList;
    }

    function loadVideos(forceLoad) {
      var cachedVideosourcesString = localStorage.getItem("videosources");
      var cachedVideosources = null;
      if (cachedVideosourcesString != null) {
        cachedVideosources = JSON.parse(cachedVideosourcesString);
        renderVideoSourceList(cachedVideosources);
      }

      // if this is the first time (not returning from a video), load the list from the server
      if (!forceLoad && sessionStorage.getItem("videosources") != null && cachedVideosourcesString != null) {
        return;
      }

      $.getJSON(getServiceURL("/videosource/client/gametv/" + (isAndroid() ? "android" : "ios")))
          .success(function (newVideosources) {
            var newVideosourcesString = JSON.stringify(newVideosources);
            if (cachedVideosources != null) {
              // count the number of new videos per source, compared to the cachedvideos
              $.each(newVideosources, function (i, newVideosource) {
                $.each(cachedVideosources, function (j, cachedVideosource) {
                  if (newVideosource.id == cachedVideosource.id) {
                    var newVideoIDsForThisVideosource = getNewVideoIDs(cachedVideosource.videoList, newVideosource.videoList);
                    sessionStorage.setItem("newVideosForSource_"+newVideosource.id, JSON.stringify(newVideoIDsForThisVideosource));
                  }
                })
              })
            }

            sessionStorage.setItem("videosources", newVideosourcesString);
            localStorage.setItem("videosources", newVideosourcesString);
            renderVideoSourceList(newVideosources);
          })
          .error(function () {
            if (cachedVideosourcesString == null) {
              $(".feedback").html("Well, there was an error loading the videos from the server. Please try again later..");
            } else {
//              $(".feedback").html("Failed to fetch latest videos, showing the last known list.");
            }
          })
    }
  </script>

  <div data-role="header" data-tap-toggle="false" data-position="fixed">
    <!--a id="downloadApp" data-icon="refresh" href="#">update app</a-->
    <a data-icon="refresh" href="#" onclick="$.mobile.loading('show'); setTimeout(function(){loadVideos(true); $.mobile.loading('hide');},400)" id="refresh_title">refresh</a>
    <h1>Game TV</h1>
    <a data-icon="grid" data-iconpos="notext" href="#editvideosources" data-role="button" data-direction="reverse" class="ui-btn-right" id="menu_title"></a>
  </div>
  <div data-role="content">
    <div class="content-primary">
      <div class="antenna"></div>
      <ul id="videosourceList" data-role="listview" data-inset="true" data-divider-theme="d"></ul>
    </div>
  </div>
  <div class="feedback"></div>
</div>



<!-- PAGE: edit videosources -->
<div data-role="page" id="editvideosources" class="videosourcespage">
  <script type="text/javascript">
    $('#editvideosources')
        .on('pagebeforeshow', function (e, data) {
          googleAnalytics("editvideosources");
          renderEditVideoSourceList(JSON.parse(localStorage.getItem("videosources")));
          $('select').slider();
          $("#editvideosources h1").html(page_editvideosources_title);
          $("#page_editvideosources_button_cancel .ui-btn-text").html(page_editvideosources_button_cancel);
          $("#page_editvideosources_button_save .ui-btn-text").html(page_editvideosources_button_save);
          $(".ui-block-b .ui-slider-label-a").html(page_editvideosources_switch_on);
          $(".ui-block-b .ui-slider-label-b").html(page_editvideosources_switch_off);
          $("#editvideosources .country_name").each(function(index, elem) {
            var countryCode = $(elem).html();
            $(elem).html(eval("country_"+countryCode));
          });
        });


    function renderEditVideoSourceList(videosources) {
      var htmlVideosource = '';
      var previousCountry = null;

      // first sort by country, done by creating an associative array of arrays
      var sortedVideosources = {};
      $.each(videosources, function (i, videosource) {
        var country = videosource.country;
        var channelsInCountry = sortedVideosources[country];
        if (channelsInCountry === undefined) {
          sortedVideosources[country] = [];
        }
        var x = sortedVideosources[country];
        x.push(videosource);
        sortedVideosources[country] = x;
      });

      // and now render the list
      $.each(sortedVideosources, function (i, videosourcesForCountry) {
        htmlVideosource += '<li data-role="list-divider"><span><img src="img/flags/' + i + '.png" width="22px"/>&nbsp;&nbsp;&nbsp;<span class="country_name">' + i + '</span></span></li>';

        $.each(videosourcesForCountry, function (j, videosource) {
          if (videosource.videoList.length > 0) { // no empty channels
            htmlVideosource += '' +
                '<li data-role="fieldcontain">' +
                '  <img src="img/videosources/' + videosource.image + '" />' +
                '  <div class="ui-grid-a">' +
                '    <div class="ui-block-a">' +
                '      <h3>' + videosource.name + '</h3>' +
                '      <p>' + videosource.website + '</p>' +
                '    </div>' +
                '    <div class="ui-block-b" style="text-align: right; margin-top: 8px">' +
                '      <select name="slider_'+videosource.id+'" id="slider_'+videosource.id+'" data-role="slider" data-mini="true" data-theme="c" data-track-theme="a">' +
                '        <option value="off" style="color:green"></option>' +
                '        <option value="on" ' + (isEnabledForUser(videosource.id) ? 'selected' : '') + '></option>' +
                '      </select>' +
                '    </div>' +
                '  </div>' +
                '</li>';
          }
        });
      });

      $("#videosourceListFull")
          .html(htmlVideosource)
          .listview('refresh');
    }
  </script>

  <div data-role="header" data-tap-toggle="false" data-position="fixed">
    <a href="#videosources" data-icon="delete" id="page_editvideosources_button_cancel"></a>
    <h1>Beheer kanalen</h1>
    <a data-icon="check" data-role="button" class="ui-btn-right"  data-iconpos="right" href="#" onclick="saveVideosources()" id="page_editvideosources_button_save"></a>
  </div>

  <div data-role="content">
    <div class="content-primary">
      <form id="editvideosourcesForm">
        <div class="antenna"></div>
        <ul id="videosourceListFull" data-role="listview" data-inset="true" data-divider-theme="d"></ul>
      </form>
    </div>
  </div>

  <div class="feedback"></div>

</div>


<!-- PAGE: videos -->
<div data-role="page" id="videos" data-videosourceid="to-be-filled">
  <script type="text/javascript">
    $('#videos')
        .on('pagebeforeshow', function (e, data) {
          if ($.mobile.pageData != null) {
            var videosourceid = $.mobile.pageData.videosourceid;
            if (videosourceid != null) {
              // remember the videosource, used when going back to videosourcelist
              $('#videos').attr('data-videosourceid', videosourceid);
              renderVideoList(videosourceid);
            }
            var videosourcename = $.mobile.pageData.videosourcename;
            if (videosourcename != null) {
              googleAnalytics("videos/"+videosourcename);
            } else {
              googleAnalytics("videos");
            }
          }
          $(".button_back .ui-btn-text").html(button_back);
        });
  </script>

  <div data-role="header" data-tap-toggle="false" data-position="fixed">
    <a href="#videosources" data-icon="arrow-l" data-direction="reverse" class="button_back"></a>
    <h1><!-- filled when loaded --></h1>
  </div>

  <div data-role="content">
    <div class="content-primary">
      <div class="antenna"></div>
      <ul id="videoList" data-role="listview" data-inset="true" data-divider-theme="d"></ul>
    </div>
    <div id="website"></div>
  </div>

  <div class="feedback"></div>

</div>


<!-- PAGE: about -->
<div data-role="page" id="about">
  <script type="text/javascript">
    $('#about')
        .on('pagebeforeshow', function (e, data) {
          $(".button_back .ui-btn-text").html(button_back);
        });
  </script>
  <div data-role="header" data-tap-toggle="false" data-position="fixed">
    <a href="#videosources" data-icon="arrow-l" data-transition="flip" data-direction="reverse" class="button_back"></a>
    <h1>Over Game TV</h1>
  </div>

  <div data-role="content">
    <div class="content-primary">
      <div class="antenna"></div>
      <ul data-role="listview" data-inset="true">
        <li>
          <h3>Wat is Game TV?</h3>
          <p>Bekijk dagelijks de nieuwste video's van de interessantste gamingsites uit binnen- en buitenland.
            De video's van de kanalen worden continu automatisch aangevuld.
          <p>
          <p>
            Mis je een kanaal? geef het aan ons door via
            <!--a href="https://twitter.com/intent/user?screen_name=_GameTV">@_GameTV</a-->
            @_GameTV of de
            <!--a href="#" onclick="redirectToAppStore()">appstore</a>.</p-->
            appstore.</p>
        </li>
        <li>
          <h3>Game TV is een product van X-Services.nl</h3>
          <p>Gewoon voor de lol, gratis en vrij van advertenties. Enjoy!</p>
        </li>
        <!--li>
          <a href="#" rel="external" onclick="redirectToAppStore()" data-icon="star">
            <h3>Beoordeel deze app</h3>
            <p>Geef je (on)gezoute mening in de appstore.</p>
          </a>
        </li-->
      </ul>
    </div>
  </div>
  </div>



<!-- PAGE: videoplayer -->
  <div data-role="page" id="videoplayer">
    <script type="text/javascript">
      $('#videoplayer')
          .on('pagebeforeshow', function (e, data) {
            googleAnalytics("videoplayer");
            $(".button_back .ui-btn-text").html(button_back);
            $("#share h3").html(page_share_title);
            $("#share #page_share_button .ui-btn-text").html(page_share_button);
            var videosourceid = $.mobile.pageData.videosourceid;
            var videoid = $.mobile.pageData.videoid;
            var cachedVideos = localStorage.getItem("videosources");
            var videosources = JSON.parse(cachedVideos);
            // find the correct videosource in the cache
            $.each(videosources, function (i, videosource) {
              if (videosource.id == videosourceid) {
               // find the correct video in the cache
                $.each(videosource.videoList, function (i, video) {
                  if (video.id == videoid) {
                    // testing this, so it kicks off after the transiton (TODO better yet, use a different event than pagebeforeshow?)
                    setTimeout(function(){renderVideoPlayer(video)}, 1000);
                    // set video as seen if applicable
                    if (nrOfNewVideos(videosourceid) > 0) {
                      var newVideoIDs = JSON.parse(sessionStorage.getItem("newVideosForSource_"+videosourceid));
                      var index = $.inArray(video.pageurl, newVideoIDs);
                      if (index > -1) {
                        // remove from array and store (remove 1 item, starting at the index of the item found)
                        newVideoIDs.splice(index, 1);
                        sessionStorage.setItem("newVideosForSource_"+videosourceid, JSON.stringify(newVideoIDs));
                        // re-render the previous page
                        renderVideoList(videosourceid);
                      }
                    }
                    return false; // breaks the loop
                  }
                })
              }
            })
          })
          .on('pagebeforehide', function (e, data) {
            // unbind click functions (done here, because we also need to unbind when it was not clicked)
            $('#videoplayer #tweetClickHijacker').unbind("click");

            // force the video to stop playing
            $("#videocontainer").html("");
          });


      function renderVideoPlayer(video) {
        // set the header
        $("#videoplayer h1").html(video.title);

        // render the player
        $("#videoplayer video").attr("poster", video.imageurl);

        var totalWidth = $("body").width();
        var totalHeight = $("body").height();
        var height = (totalWidth / (totalWidth < totalHeight ? 2 : 3)) - 30;
        var width = "100%";

        var videourl = video.videourl;

        if (isYouTube(videourl)) {
          $("#videocontainer").html('<iframe width="'+width+'" height="'+height+'" type="text/html" src="'+videourl+'?hd=1&autoplay=true&modestbranding=1&rel=0&showinfo=0" frameborder="0" allowfullscreen></iframe>');
        } else {
          if (isIOS()) {
            width = "95%";
          }
          $("#videocontainer").html('\
              <video style="z-index:1008" width="'+width+'" height="'+height+'" src="'+videourl+'" type="video/mp4" autobuffer controls poster="'+video.imageurl+'">\
                <object classid="clsid:02bf25d5-8c17-4b23-bc80-d3488abddc6b" width="'+width+'" height="'+height+'" codebase="http://www.apple.com/qtactivex/qtplugin.cab">\
                  <param value="'+videourl+'" type="video/mp4">\
                  <embed src="'+videourl+'" type="video/mp4" width="'+width+'" height="'+height+'" controller="false" pluginspage="http://www.apple.com/quicktime/download/"></embed>\
                </object>\
              </video>');
        }

        $("#videoplayer #mailbody").html('Check "'+video.title+'" @ ' + video.pageurl);
        if (video.description) {
          $("#videoplayer #description").html(video.description + (video.description.length == 255 ? ".." : "")); // TODO serverfix & remove any links and images!
        } else {
          $("#videoplayer #description").html(video.title);
        }

        // add dynamically updated tweet button
        var tweetButton = '';
        tweetButton += '<a href="https://twitter.com/share" class="twitter-share-button" data-text="'+video.title+'" data-size="large" data-lang="en" data-via="_GameTV" data-url="'+video.pageurl+'">Tweet</a>';
        $('#videoplayer #sharebytweet').html(tweetButton);
        twttr.widgets.load();

        // mask the tweet button, so we can intercept clicks and open a web intent
        $('#videoplayer #tweetClickHijacker').click(function() {
          googleAnalytics("tweet");
          var twitterWebIntentUrl = encodeURI('https://twitter.com/intent/tweet?via=_GameTV&text='+video.title+'&url='+video.pageurl);
          if (isMobile()) {
            // open in childbrowser, so iOS users can navigate back to the app
            window.plugins.childBrowser.showWebPage(twitterWebIntentUrl);
          } else {
            // childbrowser is only available for iOS and Android
            window.open(twitterWebIntentUrl);
          }
        });
      }
    </script>

  <div data-role="header" data-tap-toggle="false" data-position="fixed">
    <a href="#videos" data-icon="arrow-l" data-direction="reverse" class="button_back"></a>
    <h1><!-- filled when loaded --></h1>
  </div>

    <div data-role="popup" id="share" data-theme="a" class="ui-corner-all">
      <a data-role="button" data-theme="a" data-icon="delete" data-iconpos="notext" onclick="$('#share').popup('close'); return false" class="ui-btn-right">Close</a>
      <form>
        <div style="padding:10px 20px;">
          <h3></h3>
          <label for="mailbody" class="ui-hidden-accessible">Tekst:</label>
          <textarea name="mailbody" id="mailbody" data-theme="a"></textarea>
          <a data-icon="arrow-r" data-role="button" data-theme="b" data-iconpos="right" onclick="$('#share').popup('close'); googleAnalytics('mail'); redirect('mailto:?subject=Leuke video gezien op Game TV voor Android&body='+document.getElementById('mailbody').innerHTML); return false" id="page_share_button"></a>
        </div>
      </form>
    </div>

  <div data-role="content">
    <div class="content-primary" style="text-align: center">

      <div class="ui-grid-a">
      	<div class="ui-block-a">
          <div class="antenna"></div>
          <div id="videocontainer"></div>
          <div id="jwvideocontainer"></div>
      	</div>
      	<div class="ui-block-b">
          <div id="description"></div><br/>
          <a id="sharebyemail" data-role="button" data-inline="true" data-mini="true" data-icon="forward" href="#share" data-rel="popup" data-transition="flip" data-position-to="window">Mail</a>
          <span id="sharebytweet"></span>
          <div id="tweetClickHijacker"></div>
          <br/>
      	</div>
      </div>
    </div>
  </div>
</div>

</body>
</html>