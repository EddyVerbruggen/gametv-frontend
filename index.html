<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no">

  <title>Game TV</title>
  <!-- NOTE: jqm loads the HEAD only once per session, so we need to include all css and js on every page (not only the first, because a reload of a page need to load all css/js as well) -->
  <link rel="stylesheet" href="js/lib/jquery.mobile-1.2.0/jquery.mobile-1.2.0.min.css"/>
  <link rel="stylesheet" href="js/lib/jquery.mobile-1.2.0/jquery.mobile.theme-1.2.0.min.css"/>
  <link rel="stylesheet" href="css/gametv.custom.css"/>
  <link rel="apple-touch-icon" href="icon.png"/><!-- for webapp usage (not intended btw, but is possible) -->
  <script src="js/lib/jquery.js"></script>
  <script src="js/gametv.custom.js"></script>
  <script src="js/jqm-init.js"></script>
  <script src="js/lib/jquery.localisation.min.js"></script>
  <script src="js/lib/jquery.mobile-1.2.0/jquery.mobile-1.2.0.min.js"></script>
  <script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
  <!-- Included pgbuild js libs here. NOTE: debugging in Android emulator is not possible for PG features,
       BUT downloading the PG build APK on the emulator is! -->
  <script src="phonegap.js"></script>
  <script src="childbrowser.js"></script>
  <script type="text/javascript">
    function addEventListeners() {
      // handle the backbutton event (only fired on Android), which can be overridden for page-specific behaviour
//      document.addEventListener("backbutton", onBackButtonPressed, true);
    }

    function onBackButtonPressed(e) {
//      alert("backbutton pressed");
//      e.preventDefault();
//      navigator.app.backHistory();
    }

    function isYouTube(url) {
      return url.indexOf("youtube") > -1;
    }

    var lang = $.localise.defaultLanguage;
    alert(lang);

    $(document).ready(function () {

//      document.addEventListener("deviceready", addEventListeners, false);

      // if this is the first time (not returning from a video), load the list from the server
      if (sessionStorage.getItem("videosources") == null) {
        loadVideos();
      }

      $('#videos').on('pagebeforeshow', function (e, data) {
        var videosourceid = getUrlParam("videosourceid");
        if (videosourceid != null) {
          renderVideoList(videosourceid);
          // set all videos as seen for this source
          if (nrOfNewVideos(videosourceid) >  0) {
            sessionStorage.setItem("newVideosForSource_"+videosourceid, JSON.stringify(new Array()));
            var cachedVideosources = JSON.parse(localStorage.getItem("videosources"));
            renderVideoSourceList(cachedVideosources);
          }
        }
      });

      $('#editvideosources').on('pagebeforeshow', function (e, data) {
        renderEditVideoSourceList(JSON.parse(localStorage.getItem("videosources")));
        $('select').slider();
      });

      $('#videoplayer').on('pagebeforeshow', function (e, data) {
        var videosourceid = getUrlParam("videosourceid");
        var videoid = getUrlParam("videoid");
        renderVideoPlayer(videosourceid, videoid);
      });

      $('#videoplayer').on('pagebeforehide', function (e, data) {
        // force the video to stop playing
        $("#videocontainer").html("");
      });

      $("#popupPanel").on("popupbeforeposition", function() {
        $("#popupPanel").css("height", $(window).height());
      });

//      $("#downloadApp").attr("href", isAndroid() ? "https://build.phonegap.com/apps/267637/download/android/?qr_key=sfqjvxAqyAAjSQvtB7pu" : "https://build.phonegap.com/apps/267637/download/ios/?qr_key=sfqjvxAqyAAjSQvtB7pu");
    });

    function loadVideos() {
      var cachedVideosourcesString = localStorage.getItem("videosources");
      var cachedVideosources = null;
      if (cachedVideosourcesString != null) {
        cachedVideosources = JSON.parse(cachedVideosourcesString);
        renderVideoSourceList(cachedVideosources);
      }
      $.getJSON(getServiceURL("/videosource/all"))
          .success(function (newVideosources) {
            var newVideosourcesString = JSON.stringify(newVideosources);
            if (cachedVideosources != null) {
              // count the number of new videos per source, compared to the cachedvideos
              $.each(newVideosources, function (i, newVideosource) {
                $.each(cachedVideosources, function (j, cachedVideosource) {
                  if (newVideosource.id == cachedVideosource.id) {
                    var newVideoIDsForThisVideosource = getNewVideoIDs(cachedVideosource.videoList, newVideosource.videoList);
                    sessionStorage.setItem("newVideosForSource_"+newVideosource.id, JSON.stringify(newVideoIDsForThisVideosource));
                  }
                })
              })
            }

            localStorage.setItem("videosources", newVideosourcesString);
            renderVideoSourceList(newVideosources);
          })
          .error(function () {
            if (cachedVideosourcesString == null) {
              $(".feedback").html("Well, there was an error loading the videos from the server. Please try again later..");
            } else {
//              $(".feedback").html("Failed to fetch latest videos, showing the last known list.");
            }
          })
    }

    function getNewVideoIDs(idContainerOldList, idContainerNewList) {
      var newList = new Array();
      $.each(idContainerNewList, function (i, idContainerNew) {
        var found = false;
        $.each(idContainerOldList, function (j, idContainerOld) {
          if (idContainerNew.id == idContainerOld.id) {
            found = true;
          }
        });
        if (!found) {
          newList.push(idContainerNew.id);
        }
      });
      return newList;
    }

    function renderVideoSourceList(videosources) {
      var htmlVideosource = '' +
          '<li data-role="list-divider">Kies een recent geupdate kanaal</li>';
      $.each(videosources, function (i, videosource) {

        if (videosource.videoList.length > 0 && isEnabledForUser(videosource.id)) { // no empty channels and only active sources
          htmlVideosource += '' +
              '<li>' +
              '  <a href="#videos?videosourceid=' + videosource.id + '">' +
              '    <img src="img/videosources/' + videosource.image + '" />' +
              '    <h3>' + videosource.name + '</h3>' +
              '    <p>' + videosource.website + '</p>';
          if (nrOfNewVideos(videosource.id) > 0) {
            htmlVideosource +=
                '    <span class="ui-li-count">' + nrOfNewVideos(videosource.id) + '</span>';
          }
          htmlVideosource +=
              '  </a>' +
              '</li>';
        }
      });
      $("#videosourceList").html(htmlVideosource);
      $("#videosourceList").listview('refresh');
    }

    function renderEditVideoSourceList(videosources) {
      var htmlVideosource = '';
      $.each(videosources, function (i, videosource) {

        if (videosource.videoList.length > 0) { // no empty channels
          htmlVideosource += '' +
              '<li data-role="fieldcontain">' +
              '  <img src="img/videosources/' + videosource.image + '" />' +
              '  <div class="ui-grid-a">' +
              '    <div class="ui-block-a">' +
              '      <h3>' + videosource.name + '</h3>' +
              '      <p>' + videosource.website + '</p>' +
              '    </div>' +
              '    <div class="ui-block-b" style="text-align: right; margin-top: 8px">' +
              '      <select name="slider_'+videosource.id+'" id="slider_'+videosource.id+'" data-role="slider" data-mini="true" data-theme="c" data-track-theme="a" onchange="trackToggle('+videosource.id+', this.value)">' +
              '        <option value="off" style="color:green">uit</option>' +
              '        <option value="on" ' + (isEnabledForUser(videosource.id) ? 'selected' : '') + '>aan</option>' +
              '      </select>' +
              '    </div>' +
              '  </div>' +
              '</li>';
        }
      });
      $("#videosourceListFull").html(htmlVideosource);
      $("#videosourceListFull").listview('refresh');
    }

    function nrOfNewVideos(videosourceid) {
      var items = sessionStorage.getItem("newVideosForSource_"+videosourceid);
      return items == null ? 0 : JSON.parse(items).length;
    }

    function isEnabledForUser(videosourceid) {
      var disabledVideosources = localStorage.getItem("disabledVideosources");
      if (disabledVideosources == null) {
        return true;
      } else {
        return $.inArray(videosourceid, JSON.parse(disabledVideosources)) == -1;
      }
    }

    function saveVideosources() {
      var disabledVideosources = new Array();
      var videosources = JSON.parse(localStorage.getItem("videosources"));
      $.each(videosources, function (i, videosource) {
        var sliderElementID = "#editvideosourcesForm #slider_"+videosource.id;
        var setting = $(sliderElementID).val();
        if (setting == "off") {
          disabledVideosources.push(videosource.id);
        }
      });
      localStorage.setItem("disabledVideosources", JSON.stringify(disabledVideosources));
      // re-render the list
      renderVideoSourceList(videosources);
    }

    function renderVideoList(videosourceid) {
      var cachedVideos = localStorage.getItem("videosources");
      var videosources = JSON.parse(cachedVideos);

      // find the correct videosource in the cache
      $.each(videosources, function (i, videosource) {
        if (videosource.id == videosourceid) {
          // set the header
          $("#videos h1").html(videosource.name);
          // render the videolist
          var htmlVideo = '';
          var sourceHasNewVideos = nrOfNewVideos(videosource.id) > 0;
          var previousDateString = null;
          $.each(videosource.videoList, function (j, video) {
            var date = new Date(video.date);
            var dateString = date.getDate() + "-" + (date.getMonth() + 1) + "-" + date.getFullYear();
            if (previousDateString == null || dateString != previousDateString) {
              htmlVideo += '' +
                  '<li data-role="list-divider">' + dateString + '</li>';
            }
            htmlVideo += '' +
                '<li>' +
                '  <a href="#videoplayer?videosourceid='+videosource.id+'&videoid='+video.id+'">' +
                '    <img src="' + video.imageurl + '" />' +
                '    <h3>' + video.title + '</h3>';
            if (video.description !== undefined) {
              htmlVideo += '    <p>' + video.description + '</p>';
            }
              if (sourceHasNewVideos) {
                var newVideoIDs = JSON.parse(sessionStorage.getItem("newVideosForSource_"+videosource.id));
                if ($.inArray(video.id, newVideoIDs) > -1) {
                  htmlVideo +=
                      '    <span class="ui-li-count">new</span>';
                }
              }
            htmlVideo +=
                '  </a>' +
                '</li>';
            previousDateString = dateString;
          });

          $("#videoList").html(htmlVideo);
          $("#videoList").listview('refresh');

          //  break the loop
          return false;
        }
      })
    }

    function renderVideoPlayer(videosourceid, videoid) {
      var cachedVideos = localStorage.getItem("videosources");
      var videosources = JSON.parse(cachedVideos);

      // find the correct videosource in the cache
      $.each(videosources, function (i, videosource) {
        if (videosource.id == videosourceid) {
         // find the correct video in the cache
          $.each(videosource.videoList, function (i, video) {
            if (video.id == videoid) {

              // set the header
              $("#videoplayer h1").html(video.title);

              // render the player
              $("#videoplayer video").attr("poster", video.imageurl);

              var totalWidth = $("body").width();
              var totalHeight = $("body").height();
              var height = (totalWidth / (totalWidth < totalHeight ? 2 : 3)) - 30;
              width = "100%";

              var videourl = video.videourl;

              if (isYouTube(videourl)) {
                $("#videocontainer").html('<iframe width="'+width+'" height="'+height+'" type="text/html" src="'+videourl+'?hd=1&autoplay=true&modestbranding=1&rel=0&showinfo=0" frameborder="0" allowfullscreen></iframe>');
              } else {
                if (isIOS()) {
                  width = "95%";
//                  height = "";
                }
                $("#videocontainer").html('\
                    <video style="z-index:1008" width="'+width+'" height="'+height+'" src="'+videourl+'" type="video/mp4" autobuffer controls poster="'+video.imageurl+'">\
                      <object classid="clsid:02bf25d5-8c17-4b23-bc80-d3488abddc6b" width="'+width+'" height="'+height+'" codebase="http://www.apple.com/qtactivex/qtplugin.cab">\
                        <param value="'+videourl+'" type="video/mp4">\
                        <embed src="'+videourl+'" type="video/mp4" width="'+width+'" height="'+height+'" controller="false" pluginspage="http://www.apple.com/quicktime/download/"></embed>\
                      </object>\
                    </video>');
              }

              $("#videoplayer #mailbody").html('Check de video "'+video.title+'" @ ' + video.pageurl);
              if (video.description) {
                $("#videoplayer #description").html(video.description + (video.description.length == 255 ? ".." : "")); // TODO serverfix & remove any links and images!
              } else {
                $("#videoplayer #description").html("");
              }

              // add dynamically updated tweet button
              var tweetButton = '';
              tweetButton += '<a href="https://twitter.com/share" class="twitter-share-button" data-text="'+video.title+'" data-size="large" data-lang="en" data-via="_GameTV" data-url="'+video.pageurl+'">Tweet</a>';
              $('#videoplayer #sharebytweet').html(tweetButton);
              twttr.widgets.load();

              // mask the tweet button, so we can intercept clicks and open a web intent
              $('#videoplayer #tweetClickHijacker').click(function() {
                $('#videoplayer #tweetClickHijacker').unbind("click");
                var twitterWebIntentUrl = encodeURI('https://twitter.com/intent/tweet?via=_GameTV&text='+video.title+'&url='+video.pageurl);
                if (isIOS() || isAndroid()) {
                  // open in childbrowser, so iOS users can navigate back to the app
                  window.plugins.childBrowser.showWebPage(twitterWebIntentUrl);
                  window.plugins.childBrowser.onClose = function () {
//                    alert('childBrowser has closed');
                  };
                  window.plugins.childBrowser.onLocationChange = function (url) {
//                    alert('childBrowser has loaded ' + url);
                  };
                  window.plugins.childBrowser.onOpenExternal = function () { // when the safari button (bottom right is pressed)
//                    alert('opening Mobile Safari!');
                  };
                } else {
                  // childbrowser is only available for iOS and Android
                  window.open(twitterWebIntentUrl);
                }
              });

              return false; // breaks the loop
            }
          })
        }
      })
    }
  </script>
</head>
<body>


<!-- PAGE: videosources -->
<div data-role="page" id="videosources" class="videosourcespage">

  <div data-role="header" data-position="fixed">
    <!--a id="downloadApp" data-icon="refresh" href="#">update app</a-->
    <h1>Game TV</h1>
    <a data-icon="grid" data-iconpos="right" href="#popupPanel" data-rel="popup" data-transition="slide" data-position-to="window" class="ui-btn-right">menu</a>
  </div>

  <div data-role="popup" id="popupPanel" data-corners="false" data-theme="none" data-shadow="false" data-tolerance="0,0">
    <br/>
    <a data-role="button" data-theme="a" data-icon="grid" data-mini="true" href="#editvideosources" data-direction="reverse">Kanelen aan / uit</a>
    <button data-theme="a" data-icon="search" data-mini="true" onclick="alert('De app is net gelanceerd en we zijn druk bezig nieuwe functies toe te voegen. Bedankt voor het geduld!')">Binnenkort meer</button>
    <!--button data-theme="a" data-icon="search" data-mini="true" onclick="alert('TODO: nodig?')">Zoek video</button-->
    <!--button data-theme="a" data-icon="info" data-mini="true" href="#about" data-transition="pop">Over Game TV</button-->
    <a data-role="button" data-theme="a" data-icon="info" data-mini="true" href="#about" data-transition="flip">Over Game TV</a>
    <button data-theme="c" data-icon="delete" data-mini="true" onclick="$('#popupPanel').popup('close')">Sluiten</button>
  </div>

  <div data-role="content">
    <div class="content-primary">
      <div class="antenna"></div>
      <ul id="videosourceList" data-role="listview" data-inset="true" data-inset="true" data-divider-theme="d"></ul>
    </div>

  </div>

  <div class="feedback"></div>

</div>


<!-- PAGE: edit videosources -->
<div data-role="page" id="editvideosources" class="videosourcespage">

  <div data-role="header" data-position="fixed">
    <h1>Beheer kanalen</h1>
    <a href="#videosources" data-icon="arrow-r" data-iconpos="right" class="ui-btn-right">annuleer</a>
  </div>

  <div data-role="content">
    <div class="content-primary">
      <form id="editvideosourcesForm">
        <div class="antenna"></div>
        <ul id="videosourceListFull" data-role="listview" data-inset="true"></ul>
        <a style="margin-top: 18px" data-icon="check" data-role="button" data-theme="b" data-iconpos="right" data-inline="false" data-mini="true" href="#videosources" onclick="saveVideosources(); return false">Opslaan</a>
      </form>
    </div>
  </div>

  <div class="feedback"></div>

</div>


<!-- PAGE: videos -->
<div data-role="page" id="videos">

  <div data-role="header" data-position="fixed">
    <a href="#videosources" data-icon="arrow-l" data-direction="reverse">terug</a>
    <h1><!-- filled when loaded --></h1>
  </div>

  <div data-role="content">
    <div class="content-primary">
      <div class="antenna"></div>
      <ul id="videoList" data-role="listview" data-inset="true" data-divider-theme="d"></ul>
    </div>
  </div>

  <div class="feedback"></div>

</div>


<!-- PAGE: about -->
<div data-role="page" id="about">

  <div data-role="header" data-position="fixed">
    <a href="#videosources" data-icon="arrow-l" data-transition="flip" data-direction="reverse">terug</a>
    <h1>Over Game TV</h1>
  </div>

  <div data-role="content">
    <div class="content-primary">
      <div class="antenna"></div>
      <ul data-role="listview" data-inset="true">
        <li>
          <h3>Wat is Game TV?</h3>
          <p>Bekijk dagelijks de nieuwste video's van de interessantste gamingsites uit binnen- en buitenland.
            De video's van de kanalen worden continu automatisch aangevuld.
          <p>
          <p>
            Mis je een kanaal? geef het aan ons door via
            <!--a href="https://twitter.com/intent/user?screen_name=_GameTV">@_GameTV</a-->
            @_GameTV of de
            <!--a href="#" onclick="redirectToAppStore()">appstore</a>.</p-->
            appstore.</p>
        </li>
        <li>
          <h3>Game TV is een product van X-Services.nl</h3>
          <p>Gewoon voor de lol, gratis en vrij van advertenties. Enjoy!</p>
        </li>
        <!--li>
          <a href="#" rel="external" onclick="redirectToAppStore()" data-icon="star">
            <h3>Beoordeel deze app</h3>
            <p>Geef je (on)gezoute mening in de appstore.</p>
          </a>
        </li-->
      </ul>
    </div>
  </div>
  </div>



<!-- PAGE: videoplayer -->
  <div data-role="page" id="videoplayer">

  <div data-role="header" data-position="fixed">
    <a href="#videos?back=1" data-icon="arrow-l" data-direction="reverse">terug</a>
    <h1><!-- filled when loaded --></h1>
  </div>

    <div data-role="popup" id="share" data-theme="a" class="ui-corner-all">
      <a data-role="button" data-theme="a" data-icon="delete" data-iconpos="notext" onclick="$('#share').popup('close'); return false" class="ui-btn-right">Close</a>
      <form>
        <div style="padding:10px 20px;">
          <h3>Mail een vriend</h3>
          <label for="mailbody" class="ui-hidden-accessible">Tekst:</label>
          <textarea name="mailbody" id="mailbody" data-theme="a"></textarea>
          <a data-icon="arrow-r" data-role="button" data-theme="b" data-iconpos="right" onclick="$('#share').popup('close'); redirect('mailto:?subject=Leuke video gezien op Game TV voor Android&body='+document.getElementById('mailbody').innerHTML); return false">Naar verzenden</a>
        </div>
      </form>
    </div>

  <div data-role="content">
    <div class="content-primary" style="text-align: center">

      <div class="ui-grid-a">
      	<div class="ui-block-a">
          <div class="antenna"></div>
          <div id="videocontainer"></div>
          <div id="jwvideocontainer"></div>
      	</div>
      	<div class="ui-block-b">
          <div id="description"></div><br/>
          <a id="sharebyemail" data-role="button" data-inline="true" data-mini="true" data-icon="forward" href="#share" data-rel="popup" data-transition="flip" data-position-to="window">Mail</a>
          <span id="sharebytweet"></span>
          <div id="tweetClickHijacker"></div>
          <br/>
      	</div>
      </div>
    </div>
  </div>
</div>

</body>
</html>